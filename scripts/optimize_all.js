const Database = require('better-sqlite3');
const path = require('path');
const fs = require('fs');

// –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞
const DATABASES = [
    'tmdb_data/tmdb_minimal_no_original.db', // –û—Å–Ω–æ–≤–Ω–∞—è –±–∞–∑–∞ —Ñ–∏–ª—å–º–æ–≤
    'tmdb_data/torrents.db',                  // –ë–∞–∑–∞ —Å–≤—è–∑–µ–π —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤
    'tmdb_data/torrents_data.db',             // –ë–∞–∑–∞ –¥–µ—Ç–∞–ª–µ–π —Ç–æ—Ä—Ä–µ–Ω—Ç–æ–≤ (—Ñ–∞–π–ª—ã, –º–µ–¥–∏–∞–∏–Ω—Ñ–æ)
    'tmdb_data/cache.db'                      // <--- –ù–û–í–ê–Ø –ë–ê–ó–ê –ö–≠–®–ê API
];

console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö...');
console.log('‚è≥ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è, –µ—Å–ª–∏ –±–∞–∑—ã –±–æ–ª—å—à–∏–µ.\n');

DATABASES.forEach(relativePath => {
    const dbPath = path.join(process.cwd(), relativePath);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª (cache.db –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞—Ç—å—Å—è, –µ—Å–ª–∏ —Å–∞–π—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏)
    if (!fs.existsSync(dbPath)) {
        console.log(`‚ö†Ô∏è –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º): ${relativePath}`);
        return;
    }

    console.log(`üìÇ –û–±—Ä–∞–±–æ—Ç–∫–∞: ${relativePath}`);
    
    let db;
    try {
        db = new Database(dbPath);
        
        // 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–ª–∏–≤–∞–µ–º WAL —Ñ–∞–π–ª
        // –≠—Ç–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ -wal –≤ –æ—Å–Ω–æ–≤–Ω–æ–π .db –∏ —É–¥–∞–ª—è–µ—Ç -wal
        process.stdout.write('   ‚àü Checkpoint (–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)... ');
        db.pragma('wal_checkpoint(TRUNCATE)');
        console.log('OK');

        // 2. –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –±–∞–∑—ã
        // –£–º–µ–Ω—å—à–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞, —É–±–∏—Ä–∞–µ—Ç –ø—É—Å—Ç–æ—Ç—ã –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏–π
        process.stdout.write('   ‚àü VACUUM (—Å–∂–∞—Ç–∏–µ –∏ –¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è)... ');
        db.exec('VACUUM;');
        console.log('OK');

        // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
        // –ü–æ–º–æ–≥–∞–µ—Ç SQLite –≤—ã–±–∏—Ä–∞—Ç—å —Å–∞–º—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ SELECT
        process.stdout.write('   ‚àü ANALYZE (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤)... ');
        db.exec('ANALYZE;');
        console.log('OK');

        console.log('   ‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.');
    } catch (e) {
        console.error(`\n   ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: ${e.message}`);
    } finally {
        if (db) db.close();
    }
    console.log(''); // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
});

console.log('‚ú® –í—Å–µ –≥–æ—Ç–æ–≤–æ! –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–∂–∞—Ç—ã.');
